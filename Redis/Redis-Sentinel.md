# Redis-Sentinel





## 故障转移

一次故障转移操作由一下步骤组成：

- 发现主服务器已经进入客观下线状态。
- 对我们当前纪元进行自增，并尝试在这个纪元中当选。

- 如果当选失败，那么在设定的故障迁移超时时间的两倍之后，重新尝试当选。如果当选成功，那么执行一下步骤。
- 选出一个从服务器，并将它升级为主服务器。
- 向被选中的从服务器发送`slaveof no one`命令，让它转变为主服务器。
- 通过发布与订阅功能，将更新后的配置传播给所有其他Sentinel，其他Sentinel对它们的配置进行更新。
- 向已下线主服务器的从服务器发送`slaveof`命令，让它们去复制新的主服务器。
- 当所有从服务器都已经开始复制新的主服务器时，领头Sentinel终止这次故障迁移操作。

每当一个Redis实例被重新配置（reconfigured）—— 无论是被设置成主服务器、从服务器、又或者被设置成其他主服务器的从服务器 —— Sentinel都会向被重新配置的实例发送一个`config rewrite`命令，从而确保这些配置会持久化在硬盘里。

Sentinel使用以下规则来选择新的主服务器：

- 在失效主服务器属下的从服务器中，那些被标记为主观下线、已断线、或者最后一次回复`ping`命令的时间大于5秒钟的从服务器都会被淘汰。
- 在失效主服务器属下的从服务器中，那些与失效主服务器连接断开的时长朝富哦`down-after`选项指定的时长10倍的从服务器都会被淘汰。
- 在经历了以上两轮淘汰之后剩下来的从服务器中，我们选出复制偏移量（replicarion offset）最大的那个从服务器作为新的主服务器；如果复制偏移量不可用，或者从服务器的复制偏移量相同，那么带有最小运行ID的那个从服务器成为新的主服务器。