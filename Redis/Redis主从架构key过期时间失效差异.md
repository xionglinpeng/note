# Redis主从架构key过期时间失效差异

## 1











## Temp



活动中用到了Redis来存放用户的奖励票信息，原则上是一天一清，现在设置的是
expireAt(零点)
但是最近运营反馈有部分用户有异常票，经过加log排查后发现指定在零点过期的key并没有准时过期，从库中在0点23秒的时候还能读到数据，程序中用了简单的exists(key) 判断key是否存在，存在就取值。
这么想可能是主库在零点过期了，但是没有及时同步到从库。在网上一看，有用户遇到同样的情况，Redis版本3。2之前的会存在这种情况，然后查看了一下我们的redis版本，发现是3.0 这也就难怪了，应该是遇到一样的情况了；

所以解决方案是在exists(key) 判断的同时加上对key 生存时间ttl的判断，如果ttl是0就不取 了。

实验：
然后我们实测了一下，现在主库设置一个key的过期时间，然后在过期时间前后去读从库，发现直接从从库读取过期key的时候确实会有延迟，5到7秒不等。但是我们读主库，基本无延迟，到点就读不到了。

总结：对于3.2之前的版本Redis会存在主从过期key同步失效的延时

相关链接：https://www.cnblogs.com/bridger/archive/2012/11/07/2758734.html

https://blog.csdn.net/u012538947/article/details/52540313

