# 分布式事务的4种模式

常见的分布式事务解决方案

1. seata阿里分布式事务框架
2. 消息队列
3. saga
4. XA

它们有一个共同点，都是“两阶段”。“两阶段”是指完成整个分布式事务，划分成两个步骤完成。

实际上，这四种常见的分布式事务解决方案，分别对应这分布式事务的四种模式：AT、TCC、Saga、XA。

四种分布式事务模式，都有各自的理论基础，分别在不同的时间被提出；每种模式都有它的适用场景，同样每个模式也都有诞生各自的代表产品。

**分布式事务理论基础**

解决分布式事务，也有相应的规范和协议。分布式事务相关的协议有2PC、3PC。

由于三阶段提交协议3PC非常难实现，目前市面主流的分布式事务解决方案都是2PC协议。这就是文章开始提及常见的分布式事务解决方案里面，那些列举的都有一个共同点“两阶段”的内在原因。

**2PC两阶段提交协议**

两阶段提交协议：事务管理器分两个阶段来协调资源管理器，第一阶段准备资源，也就是预留事务所需的资源，如果每个资源管理器都预留资源成功，则进行第二阶段资源提交，否则协调资源管理器回滚资源。

2PC协议的核心是，划分出了事务参与者和协调者的角色，并将整个过程划分成两个阶段。

第一阶段：所有事务参与者，执行后进行与提交；直到协调者收到所有参与者的预提交才会进入第二阶段。

- 如果在协调者的超时时间内，有任意参与者的预提交preCommit没发送或未送达，都会结束事务。

第二阶段：所有事务预提交了各自的结果后，由协调者决定最终事务是成功（commit）还是失败（rollback）。

二阶段提交看起来确实能够提供原子性的操作，但是不幸的是，二阶段提交还是有几个缺点的：

1. 执行过程中，所有参与节点都是事物阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态。
2. 参与者发生故障。协调者需要给每个参与者额外指定超时机制，超时后整个事务失败。
3. 协调者发生故障。参与者会一直阻塞下去。需要额外的备机进行容错。
4. 二阶段无法解决的问题：协调者在发出commit消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否已经被提交。



