# 分布式事务

事务的概念

一个数据库事务通常包含对数据库进行读或写的一个操作序列。它的存在包含有以下两个目的：

1. 为数据库操作提供了一个从失败中恢复到正常状态的方法，同时提供了数据库即使在异常状态仍能保持一致性的方法。
2. 当多个应用程序在并发访问数据库时，可以在这些应用程序之间提供一个隔离方法，以防止彼此的操作相互干扰。

事务特性

事务具有4个特性：原子性、一致性、隔离性、持久性。这四个属性通常称为ACID特性。

原子性

​	一个事务是一个不可分割的工作单位，事务中包括的诸操作要么都成功，要么都失败。

一致性

​	



![1636469108425](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469108425.png)



事务的隔离级别





![1636469655356](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469655356.png)



![1636469771650](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469771650.png)



![1636469819662](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469819662.png)

![1636469869240](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469869240.png)

![1636469883304](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469883304.png)

![1636469905046](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469905046.png)

![1636469924724](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469924724.png)

![1636469944564](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469944564.png)

![1636469972904](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469972904.png)

![1636469988200](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636469988200.png)

![1636470016695](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636470016695.png)

![1636470070852](C:\Users\xlp\AppData\Roaming\Typora\typora-user-images\1636470070852.png)

















CAP定理

C（Consistency）

一致性，分布式系统中的所有数据备份，在同一时刻具有同样的值，所有节点在同一时刻读取的数据都是最新的数据副本。

A（Availability）

可用性，非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）。可用性的两个关键：一个是合理的时间，另一个是合理的响应。合理的时间指的是请求不能无限被阻塞，应该在合理的时间给出返回；合理的响应指的是系统应该明确返回结果并且结果是正确的。

P（Partition Tolerance）

分区容错，当出现网络分区后，系统能够继续工作。例如有5台机器集群，其中2台和3台分别分布在不同的机房，如果这两个机房之间网络不能互通，即发生了网络分区。

CAP定理特性

- CAP原理证明，任何分布式系统只可以同时满足以上两点，无法三种兼顾。在分布式系统中，网络无法100%可靠，分区其实是一个必然现象。

- 如果选择了CA而放弃了P，那么当发生分区现象时，为了保证一致性，必须拒绝请求，但是A又不允许，所以分布式系统理论上不可能选择CA架构，只能选择CP或者AP架构。

- 对于CP来说，放弃可用性，追求一致性和分区容错性，ZooKeeper其实追求的就是强一致。

- 对于AP来说，放弃一致性（强一致性），追求可用性和分区容错性，这是很多分布式系统设计时的选择。

- CAP理论是忽略网络延迟的，即在实际当中，总会有一定的时间是不一致的。

- CAP中选择两个，比如选择了CP，并不是要放弃A。



## 数据库事务

数据库事务四大特性（ACID）

- 原子性（Atomicity）：
- 一致性（Consistency）：
- 隔离性（Isolation）：
- 持久性（Durability）：

## 分布式事务



拆分：

1. 水平拆分
2. 垂直拆分

CAP理论

1. C（Consistency）：
2. A（Availability）：
3. P（Partition Tolerance）：

BASE理论

1. Basically Available（基本可用）
2. Soft State（软状态）
3. Eventually Consistent（最终一致性）

两阶段提交（2PC）



2PC分为两个阶段：

1. 投票阶段（Voting Phase）:
2. 提交阶段（Commit Phase）:

补偿事务（TCC）

TCC3阶段：

1. Try阶段：
2. Confirm阶段：
3. Cancel阶段：

后置提交

本地消息表（异步确保）



分布式事务解决方案

1. 消息队列
2. AT
3. TCC
4. Saga
5. XA







### XA

XA协议是有Tuxedo首先提出的，并交给X/Open组织，作为资源管理器（数据库）与实务管理器的接口标准。目前，Oracle、Informix、DB2和Sybase等各大数据库厂家都提供对XA的支持。XA协议采用两阶段提交方式来管理分布式事务。XA接口提供资源管理器与事务管理器之间进行通信的标准接口。XA协议包括两套函数，以xa_开头的以及以ax_开头的。





## 2PC



## 3PC



## TCC







